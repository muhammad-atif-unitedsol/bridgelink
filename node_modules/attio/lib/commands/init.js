import boxen from "boxen";
import chalk from "chalk";
import { Argument, Command } from "commander";
import { z } from "zod";
import { isErrored } from "@attio/fetchable-npm";
import { authenticator } from "../auth/auth.js";
import { printCreateProjectError, printFetcherError } from "../print-errors.js";
import { getAppInfo } from "../spinners/get-app-info.spinner.js";
import { printLogo } from "../util/print-logo.js";
import { createProject } from "./init/create-project.js";
export const argsSchema = z.string();
export const init = new Command("init")
    .description("Initialize a new Attio app")
    .addArgument(new Argument("<app-slug>", "The app slug, chosen in the developer dashboard"))
    .action(async (unparsedArgs) => {
    try {
        printLogo();
        const appSlug = argsSchema.parse(unparsedArgs);
        await authenticator.ensureAuthed();
        const appInfoResult = await getAppInfo(appSlug);
        if (isErrored(appInfoResult)) {
            printFetcherError("Failed to fetch app info", appInfoResult.error);
            process.exit(1);
        }
        const appInfo = appInfoResult.value;
        const result = await createProject({
            appSlug,
            appInfo,
        });
        if (isErrored(result)) {
            printCreateProjectError(result.error);
            process.exit(1);
        }
        process.stdout.write(`${chalk.green(`SUCCESS!! ðŸŽ‰ Your app directory has been created.`)}

To get started, run:

${boxen(`cd ${appSlug}\nnpm install\nnpm run dev`, {
            padding: 1,
            margin: 1,
            borderStyle: "round",
        })}

(${chalk.yellow("yarn")}, ${chalk.yellow("pnpm")}, and ${chalk.yellow("bun")} also work!)
`);
        process.exit(0);
    }
    catch (error) {
        process.stderr.write(`${chalk.red(`âœ– ${error}`)}\n`);
        process.exit(1);
    }
});
