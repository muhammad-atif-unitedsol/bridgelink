import { Command } from "commander";
import { isErrored } from "@attio/fetchable-npm";
import { ensureAppEntryPoint } from "../util/ensure-app-entry-point.js";
import { exitWithMissingEntryPoint } from "../util/exit-with-missing-entry-point.js";
import { hardExit } from "../util/hard-exit.js";
import { spinnerify } from "../util/spinner.js";
import { printJsError, printTsError } from "../util/typescript.js";
import { buildJavaScript } from "./build/build-javascript.js";
import { validateTypeScript } from "./build/validate-typescript.js";
import { graphqlCodeGen } from "./dev/graphql-code-gen.js";
import { printBuildContextError } from "./dev/prepare-build-context.js";
export const build = new Command("build")
    .description("Build your Attio extension locally")
    .action(async () => {
    const appEntryPointResult = await ensureAppEntryPoint();
    if (isErrored(appEntryPointResult)) {
        exitWithMissingEntryPoint();
    }
    const generateGraphqlOperationsResult = await spinnerify("Generating GraphQL types...", "GraphQL types generated successfully", graphqlCodeGen);
    if (isErrored(generateGraphqlOperationsResult)) {
        hardExit(generateGraphqlOperationsResult.error.error.toString());
    }
    const tsResult = await spinnerify("Validating TypeScript...", "TypeScript validation passed", validateTypeScript);
    if (isErrored(tsResult)) {
        switch (tsResult.error.code) {
            case "VALIDATE_TYPE_SCRIPT_ERROR":
                tsResult.error.errors.forEach(printTsError);
                process.stderr.write("TypeScript validation failed");
                process.exit(1);
            case "FILE_SYSTEM_ERROR":
                process.stderr.write(`TypeScript validation failed due to a file system error: ${tsResult.error.error}`);
                process.exit(1);
        }
    }
    const jsResult = await spinnerify("Building JavaScript...", "JavaScript build completed successfully", buildJavaScript);
    if (isErrored(jsResult)) {
        if (jsResult.error.code === "BUILD_JAVASCRIPT_ERROR") {
            const { errors, warnings } = jsResult.error;
            errors?.forEach((error) => printJsError(error, "error"));
            warnings?.forEach((warning) => printJsError(warning, "warning"));
            process.stderr.write("JavaScript build failed");
            process.exit(1);
        }
        else {
            printBuildContextError(jsResult.error);
            process.stderr.write("Build context error");
            process.exit(1);
        }
    }
});
