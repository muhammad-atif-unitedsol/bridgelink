import { existsSync } from "fs";
import path from "path";
import { fileURLToPath } from "url";
import { complete, errored, isErrored } from "@attio/fetchable-npm";
import { canWrite } from "../../util/can-write.js";
import { copyWithTransform } from "../../util/copy-with-replace.js";
import { createDirectory } from "../../util/create-directory.js";
import { spinnerify } from "../../util/spinner.js";
export async function createProject({ appSlug, appInfo, }) {
    return await spinnerify("Creating project...", "Project created", async () => {
        const cwd = process.cwd();
        const projectPath = path.join(cwd, appSlug);
        if (existsSync(projectPath)) {
            return errored({ code: "DIRECTORY_ALREADY_EXISTS", path: projectPath });
        }
        if (!canWrite(cwd)) {
            return errored({ code: "WRITE_ACCESS_DENIED", path: cwd });
        }
        const __dirname = path.dirname(fileURLToPath(import.meta.url));
        const projectDirResult = await createDirectory(appSlug);
        if (isErrored(projectDirResult)) {
            return projectDirResult;
        }
        const projectDir = projectDirResult.value;
        const templateDir = path.resolve(__dirname, "../../template");
        const transform = (contents) => contents
            .replaceAll("title-to-be-replaced", appInfo.title)
            .replaceAll("id-to-be-replaced", appInfo.app_id)
            .replaceAll("slug-to-be-replaced", appSlug);
        const result = await copyWithTransform(templateDir, projectDir, transform);
        if (isErrored(result)) {
            return result;
        }
        return complete(undefined);
    });
}
