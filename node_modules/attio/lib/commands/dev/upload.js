import notifier from "node-notifier";
import { combineAsync, complete, isErrored } from "@attio/fetchable-npm";
import { api } from "../../api/api.js";
import { spinnerify } from "../../util/spinner.js";
import { uploadBundle } from "../../util/upload-bundle.js";
export async function upload({ contents, devVersionId, appId, }) {
    return await spinnerify("Uploading...", () => `Upload complete at ${new Date().toLocaleTimeString()}`, async () => {
        const startUploadResult = await api.startUpload({
            appId,
            devVersionId,
        });
        if (isErrored(startUploadResult)) {
            return startUploadResult;
        }
        const { client_bundle_upload_url, server_bundle_upload_url, app_dev_version_bundle_id: bundleId, } = startUploadResult.value;
        const [clientBundle, serverBundle] = contents;
        const uploadResults = await combineAsync([
            uploadBundle(clientBundle, client_bundle_upload_url),
            uploadBundle(serverBundle, server_bundle_upload_url),
        ]);
        if (isErrored(uploadResults)) {
            return uploadResults;
        }
        const completeBundleUploadResult = await api.completeBundleUpload({
            appId,
            devVersionId,
            bundleId,
        });
        if (isErrored(completeBundleUploadResult)) {
            return completeBundleUploadResult;
        }
        try {
            notifier.notify({
                title: "Upload Complete",
                message: "New bundle uploaded to Attio",
            });
        }
        catch {
        }
        return complete(undefined);
    });
}
