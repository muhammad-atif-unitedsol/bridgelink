import open from "open";
import { isErrored } from "@attio/fetchable-npm";
import { api } from "../../api/api.js";
import { APP } from "../../env.js";
import { listenForKey } from "../../util/listen-for-key.js";
function prompt() {
    process.stdout.write(`ðŸš¨ IMPORTANT: You will need to install your app in your workspace. Press "i" to open the app settings page, and then click "Install".\n\n`);
}
export function onboarding({ appId, appSlug, workspace, }) {
    const cleanup = listenForKey("i", () => {
        open(`${APP}/${workspace.slug}/settings/apps/${appSlug}`);
    });
    const poll = async () => {
        const installationResult = await api.fetchInstallation({
            appId,
            workspaceId: workspace.workspace_id,
        });
        if (isErrored(installationResult)) {
            return;
        }
        let installation = installationResult.value;
        if (!installation) {
            prompt();
            while (!installation) {
                await new Promise((resolve) => setTimeout(resolve, 60_000));
                const installationResult = await api.fetchInstallation({
                    appId,
                    workspaceId: workspace.workspace_id,
                });
                if (isErrored(installationResult)) {
                    return;
                }
                installation = installationResult.value;
                if (!installation) {
                    prompt();
                }
            }
            cleanup();
        }
    };
    poll();
    return cleanup;
}
