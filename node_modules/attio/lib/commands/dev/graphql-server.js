import { fileURLToPath } from "url";
import { dirname } from "path";
import path from "path";
import fs from "fs";
import { buildSchema } from "graphql";
import { Hono } from "hono";
import { serve } from "@hono/node-server";
import { graphqlServer as graphqlServerMiddleware } from "@hono/graphql-server";
import { findAvailablePort } from "../../util/find-available-port.js";
import open from "open";
import { listenForKey } from "../../util/listen-for-key.js";
export function graphqlServer() {
    let server = null;
    let port;
    let isShuttingDown = false;
    const startServer = async () => {
        if (isShuttingDown)
            return;
        try {
            const currentFilePath = fileURLToPath(import.meta.url);
            const currentDirPath = dirname(currentFilePath);
            const schemaPath = path.resolve(currentDirPath, "..", "..", "..", "schema.graphql");
            const schemaString = fs.readFileSync(schemaPath, "utf8");
            port = await findAvailablePort(8700);
            const schema = buildSchema(schemaString);
            const app = new Hono();
            const rootResolver = () => {
                return {};
            };
            app.use("/graphql", graphqlServerMiddleware({
                schema,
                rootResolver,
                graphiql: true,
            }));
            server = serve({
                fetch: app.fetch,
                port,
            });
            process.stdout.write(`\n\n Press "o" to open GraphQL Explorer.\n\n`);
        }
        catch (error) {
            process.stderr.write(`Failed to start GraphQL server: ${error}\n`);
            throw error;
        }
    };
    startServer().catch((error) => {
        process.stderr.write(`GraphQL server failed to start: ${error}\n`);
    });
    const cleanup = listenForKey("o", () => {
        if (port) {
            open(`http://localhost:${port}/graphql`);
        }
    });
    return () => {
        isShuttingDown = true;
        cleanup();
        if (server) {
            try {
                server.close();
            }
            catch (error) {
                process.stderr.write(`Error closing GraphQL server: ${error}\n`);
            }
        }
    };
}
