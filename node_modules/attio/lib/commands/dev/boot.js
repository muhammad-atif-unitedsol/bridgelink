import { isErrored } from "@attio/fetchable-npm";
import { api } from "../../api/api.js";
import { printCliVersionError, printDetermineWorkspaceError, printFetcherError, printPackageJsonError, } from "../../print-errors.js";
import { determineWorkspace } from "../../spinners/determine-workspace.spinner.js";
import { getAppInfo } from "../../spinners/get-app-info.spinner.js";
import { getAppSlugFromPackageJson } from "../../spinners/get-app-slug-from-package-json.js";
import { loadAttioCliVersion } from "../../util/load-attio-cli-version.js";
import { loadEnv } from "../../util/load-env.js";
export async function boot({ workspaceSlug }) {
    const appSlugResult = await getAppSlugFromPackageJson();
    if (isErrored(appSlugResult)) {
        printPackageJsonError(appSlugResult.error);
        process.exit(1);
    }
    const appSlug = appSlugResult.value;
    const appInfoResult = await getAppInfo(appSlug);
    if (isErrored(appInfoResult)) {
        printFetcherError("Error loading app info", appInfoResult.error);
        process.exit(1);
    }
    const appInfo = appInfoResult.value;
    const workspaceResult = await determineWorkspace(workspaceSlug);
    if (isErrored(workspaceResult)) {
        printDetermineWorkspaceError(workspaceResult.error);
        process.exit(1);
    }
    const workspace = workspaceResult.value;
    const environmentVariables = await loadEnv();
    const cliVersionResult = loadAttioCliVersion();
    if (isErrored(cliVersionResult)) {
        printCliVersionError(cliVersionResult);
        process.exit(1);
    }
    const cliVersion = cliVersionResult.value;
    const devVersionResult = await api.createDevVersion({
        appId: appInfo.app_id,
        cliVersion,
        targetWorkspaceId: workspace.workspace_id,
        environmentVariables,
    });
    if (isErrored(devVersionResult)) {
        printFetcherError("Error creating dev version", devVersionResult.error);
        process.exit(1);
    }
    const devVersion = devVersionResult.value;
    return {
        appId: appInfo.app_id,
        appSlug,
        devVersionId: devVersion.app_dev_version_id,
        workspace,
    };
}
