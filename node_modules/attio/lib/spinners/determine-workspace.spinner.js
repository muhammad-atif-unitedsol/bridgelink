import { select } from "@inquirer/prompts";
import { complete, errored, isErrored } from "@attio/fetchable-npm";
import { api } from "../api/api.js";
import { spinnerify } from "../util/spinner.js";
export async function determineWorkspace(workspaceSlug) {
    const workspacesResult = await spinnerify("Loading workspaces...", "Workspaces loaded", async () => await api.fetchWorkspaces());
    if (isErrored(workspacesResult)) {
        return workspacesResult;
    }
    const workspaces = workspacesResult.value;
    const workspace = workspaces.find((workspace) => workspace.slug === workspaceSlug);
    if (workspace) {
        process.stdout.write(`Using workspace: ${workspace.name}`);
        return complete(workspace);
    }
    if (workspaceSlug) {
        return errored({ code: "NO_WORKSPACE_FOUND", workspace_slug: workspaceSlug });
    }
    if (workspaces.length === 0) {
        return errored({ code: "NO_WORKSPACES_FOUND" });
    }
    if (workspaces.length === 1) {
        process.stdout.write(`Using workspace: ${workspaces[0].name}`);
        return complete(workspaces[0]);
    }
    const choice = await select({
        message: "Choose a workspace",
        choices: workspaces.map((workspace) => ({
            name: workspace.name,
            value: workspace,
        })),
    });
    process.stdout.write(`Using workspace: ${choice.name}`);
    return complete(choice);
}
