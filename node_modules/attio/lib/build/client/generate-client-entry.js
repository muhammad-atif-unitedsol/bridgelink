import fs from "fs/promises";
import path from "path";
import { Project } from "ts-morph";
import { complete, errored, fromPromise, isComplete } from "@attio/fetchable-npm";
import { APP_SETTINGS_FILENAME } from "../../constants/settings-files.js";
import { getAppEntryPoint } from "../../util/get-app-entry-point.js";
const ASSET_FILE_EXTENSIONS = ["png"];
export async function generateClientEntry({ srcDirAbsolute, assetsDirAbsolute, }) {
    const appEntryPoint = await getAppEntryPoint(srcDirAbsolute);
    if (!appEntryPoint) {
        return errored({
            code: "APP_ENTRY_POINT_NOT_FOUND",
        });
    }
    const tsProject = new Project({
        useInMemoryFileSystem: true,
    });
    const appSourceFile = tsProject.createSourceFile(appEntryPoint.path, appEntryPoint.content);
    const exported = appSourceFile.getExportedDeclarations();
    const hasAppExport = exported.has("app");
    if (!hasAppExport) {
        return errored({
            code: "APP_EXPORT_NOT_FOUND",
            path: appEntryPoint.path,
        });
    }
    const assetFilesResult = await fromPromise(fs.readdir(assetsDirAbsolute, { recursive: true }));
    const assetFiles = isComplete(assetFilesResult) ? assetFilesResult.value : [];
    const assets = assetFiles
        .filter((relativeAssetPath) => ASSET_FILE_EXTENSIONS.some((extension) => relativeAssetPath.endsWith("." + extension)))
        .map((relativeAssetPath) => ({
        path: path.join(assetsDirAbsolute, relativeAssetPath),
        name: relativeAssetPath,
    }));
    const settingsSchemaResult = await fromPromise(fs.readFile(path.join(srcDirAbsolute, APP_SETTINGS_FILENAME)));
    const initSettingsJS = isComplete(settingsSchemaResult)
        ? `
            import appSettingsSchema from ${JSON.stringify(path.join(srcDirAbsolute, APP_SETTINGS_FILENAME))}

            registerSettingsSchema(appSettingsSchema)
        `
        : `
            registerSettingsSchema({workspace: {}})
        `;
    const importAppJS = `
        import {app} from ${JSON.stringify(appEntryPoint.path)}
    `;
    const registerSurfacesJS = `
        const recordActions = app?.record?.actions
        const bulkRecordActions = app?.record?.bulkActions
        const recordWidgets = app?.record?.widgets
        const callRecordingInsights = app?.callRecording?.insight?.textActions
        const callRecordingSummaries = app?.callRecording?.summary?.textActions
        const callRecordingTranscripts = app?.callRecording?.transcript?.textActions
        const workflowStepBlocks = app?.workflow?.blocks?.steps
        const workflowTriggerBlocks = app?.workflow?.blocks?.triggers
        const workspaceSettings = app?.settings?.workspace

        registerSurfaces({
            "record-action": Array.isArray(recordActions) ? recordActions : [],
            "bulk-record-action": Array.isArray(bulkRecordActions) ? bulkRecordActions : [],
            "record-widget":  Array.isArray(recordWidgets) ? recordWidgets : [],
            "call-recording-insight-text-selection-action":  Array.isArray(callRecordingInsights) ? callRecordingInsights : [],
            "call-recording-summary-text-selection-action":  Array.isArray(callRecordingSummaries) ? callRecordingSummaries : [],
            "call-recording-transcript-text-selection-action":  Array.isArray(callRecordingTranscripts) ? callRecordingTranscripts : [],
            "workflow-block": [
                ...(Array.isArray(workflowStepBlocks)
                    ? workflowStepBlocks.map((block) => ({type: "step", id: block.id, block}))
                    : []),
                ...(Array.isArray(workflowTriggerBlocks)
                    ? workflowTriggerBlocks.map((block) => ({type: "trigger", id: block.id, block}))
                    : []),
            ],
            "workspace-settings": workspaceSettings ? [workspaceSettings] : [],
        })
    `;
    const importAssetsJS = assets
        .map((asset, index) => `import A${index} from ${JSON.stringify(asset.path)};`)
        .join("\n");
    const registerAssetsJS = `
        const assets = [];

         ${assets
        .map((asset, index) => `assets.push({name: ${JSON.stringify(asset.name)}, data: A${index}});`)
        .join("\n")}

        registerAssets(assets);
    `;
    return complete(`
        ${importAppJS}
        ${importAssetsJS}

        ${initSettingsJS}

        ${registerSurfacesJS}

        ${registerAssetsJS}
    `);
}
