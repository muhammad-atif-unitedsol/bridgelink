import fs from "fs/promises";
import path from "path";
import { z } from "zod";
import { complete, errored, fromPromise, fromThrowable, isErrored } from "@attio/fetchable-npm";
import { HIDDEN_ATTIO_DIRECTORY } from "../constants/hidden-attio-directory.js";
const tsconfigSchema = z
    .object({
    include: z.array(z.string()),
})
    .passthrough();
export async function addAttioHiddenDirectoryToTsConfig() {
    const tsconfigPath = path.resolve("./tsconfig.json");
    const tsconfigContentResult = await fromPromise(fs.readFile(tsconfigPath, "utf-8"));
    if (isErrored(tsconfigContentResult)) {
        const { error } = tsconfigContentResult;
        if (typeof error === "object" &&
            error !== null &&
            "code" in error &&
            error.code === "ENOENT") {
            return errored({ code: "TS_CONFIG_NOT_FOUND" });
        }
        return errored({ code: "FAILED_TO_READ_TSCONFIG" });
    }
    const tsconfigResult = fromThrowable(() => tsconfigSchema.parse(JSON.parse(tsconfigContentResult.value)));
    if (isErrored(tsconfigResult)) {
        return errored({ code: "FAILED_TO_PARSE_TSCONFIG" });
    }
    const hiddenAttioDirectoryBlob = `${HIDDEN_ATTIO_DIRECTORY}/**/*`;
    if (tsconfigResult.value.include.includes(hiddenAttioDirectoryBlob)) {
        return complete(false);
    }
    const updatedTsconfig = {
        ...tsconfigResult.value,
        include: [...tsconfigResult.value.include, hiddenAttioDirectoryBlob],
    };
    const writeResult = await fromPromise(fs.writeFile(tsconfigPath, JSON.stringify(updatedTsconfig, null, 2)));
    if (isErrored(writeResult)) {
        return errored({ code: "FAILED_TO_WRITE_TSCONFIG" });
    }
    return complete(true);
}
