import { promises as fs } from "fs";
import path from "path";
import { combineAsync, complete, errored, isErrored } from "@attio/fetchable-npm";
export async function copyWithTransform(srcDir, destDir, transform) {
    try {
        await fs.mkdir(destDir, { recursive: true });
    }
    catch {
        return errored({ code: "FAILED_TO_CREATE_DIRECTORY", path: destDir });
    }
    let entries;
    try {
        entries = await fs.readdir(srcDir, { withFileTypes: true });
    }
    catch {
        return errored({ code: "FAILED_TO_LIST_FILES", path: srcDir });
    }
    const results = await combineAsync(entries.map(async (entry) => {
        const srcPath = path.join(srcDir, entry.name);
        const destPath = path.join(destDir, entry.name);
        if (entry.isDirectory()) {
            return await copyWithTransform(srcPath, destPath, transform);
        }
        else if (entry.isFile()) {
            if (entry.name.startsWith(".") ||
                /\.(jpg|jpeg|png|gif|svg|webp|ico)$/i.test(entry.name)) {
                try {
                    await fs.copyFile(srcPath, destPath);
                }
                catch {
                    return errored({ code: "FAILED_TO_COPY_FILE", src: srcPath, dest: destPath });
                }
            }
            else {
                let content;
                try {
                    content = await fs.readFile(srcPath, "utf8");
                }
                catch {
                    return errored({ code: "FAILED_TO_READ_FILE", path: srcPath });
                }
                content = transform(content);
                try {
                    await fs.writeFile(destPath, content, "utf8");
                }
                catch {
                    return errored({ code: "FAILED_TO_WRITE_FILE", path: destPath });
                }
            }
        }
        return complete(undefined);
    }));
    if (isErrored(results)) {
        return results;
    }
    return complete(undefined);
}
