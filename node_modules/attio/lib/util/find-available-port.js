import net from "net";
import { hardExit } from "./hard-exit.js";
async function isPortAvailable(port) {
    return new Promise((resolve) => {
        const portTester = net.createConnection(port, "127.0.0.1");
        portTester.setTimeout(1000);
        const cleanup = () => {
            portTester.removeAllListeners();
            portTester.destroy();
        };
        portTester.once("error", (err) => {
            cleanup();
            if (err.code === "ECONNREFUSED") {
                resolve(true);
            }
            else {
                resolve(false);
            }
        });
        portTester.once("connect", () => {
            cleanup();
            resolve(false);
        });
        portTester.once("timeout", () => {
            cleanup();
            resolve(false);
        });
    });
}
export async function findAvailablePort(startPort, maxAttempts = 100) {
    for (let port = startPort; port < startPort + maxAttempts; port++) {
        if (await isPortAvailable(port)) {
            return port;
        }
    }
    hardExit(`Could not find an available port after ${maxAttempts} attempts`);
}
