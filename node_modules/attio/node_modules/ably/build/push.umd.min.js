/*@license Copyright 2015-2022 Ably Real-time Ltd (ably.com)

Ably JavaScript Library v2.16.0
https://github.com/ably/ably-js

Released under the Apache Licence v2.0*/(function (g, f) {
    if ("object" == typeof exports && "object" == typeof module) {
      module.exports = f();
    } else if ("function" == typeof define && define.amd) {
      define([], f);
    } else if ("object" == typeof exports) {
      exports["AblyPushPlugin"] = f();
    } else {
      g["AblyPushPlugin"] = f();
    }
  }(this, () => {
var exports = {};
var module = { exports };
"use strict";var R=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptor,ne=Object.getOwnPropertyDescriptors,re=Object.getOwnPropertyNames,H=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable;var J=(n,e,t)=>e in n?R(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,q=(n,e)=>{for(var t in e||(e={}))_.call(e,t)&&J(n,t,e[t]);if(H)for(var t of H(e))ie.call(e,t)&&J(n,t,e[t]);return n},z=(n,e)=>ee(n,ne(e));var oe=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),se=(n,e)=>{for(var t in e)R(n,t,{get:e[t],enumerable:!0})},ae=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of re(e))!_.call(n,i)&&i!==t&&R(n,i,{get:()=>e[i],enumerable:!(r=te(e,i))||r.enumerable});return n};var ce=n=>ae(R({},"__esModule",{value:!0}),n);var X=oe(()=>{});var Ce={};se(Ce,{ActivationStateMachine:()=>k,CalledActivate:()=>c,CalledDeactivate:()=>f,PushChannel:()=>F,default:()=>ke,getW3CPushDeviceDetails:()=>w,localDeviceFactory:()=>j});module.exports=ce(Ce);var N=class{constructor(e){this.channel=e,this.client=e.client}async subscribeDevice(){let e=this.client,t=e.device(),r=e.options.useBinaryProtocol?e.Utils.Format.msgpack:e.Utils.Format.json,i={deviceId:t.id,channel:this.channel.name},o=e.Defaults.defaultPostHeaders(e.options);e.options.headers&&e.Utils.mixin(o,e.options.headers),e.Utils.mixin(o,this._getPushAuthHeaders());let s=e.Utils.encodeBody(i,e._MsgPack,r);await e.rest.Resource.post(e,"/push/channelSubscriptions",s,o,{},r,!0)}async unsubscribeDevice(){let e=this.client,t=e.device(),r=e.options.useBinaryProtocol?e.Utils.Format.msgpack:e.Utils.Format.json,i=e.Defaults.defaultPostHeaders(e.options);e.options.headers&&e.Utils.mixin(i,e.options.headers),e.Utils.mixin(i,this._getPushAuthHeaders()),await e.rest.Resource.delete(e,"/push/channelSubscriptions",i,{deviceId:t.id,channel:this.channel.name},r,!0)}async subscribeClient(){let e=this.client,t=this.client.auth.clientId;if(!t)throw new this.client.ErrorInfo("Cannot subscribe from client without client ID",5e4,500);let r=e.options.useBinaryProtocol?e.Utils.Format.msgpack:e.Utils.Format.json,i={clientId:t,channel:this.channel.name},o=e.Defaults.defaultPostHeaders(e.options);e.options.headers&&e.Utils.mixin(o,e.options.headers);let s=e.Utils.encodeBody(i,e._MsgPack,r);await e.rest.Resource.post(e,"/push/channelSubscriptions",s,o,{},r,!0)}async unsubscribeClient(){let e=this.client,t=this.client.auth.clientId;if(!t)throw new this.client.ErrorInfo("Cannot unsubscribe from client without client ID",5e4,500);let r=e.options.useBinaryProtocol?e.Utils.Format.msgpack:e.Utils.Format.json,i=e.Defaults.defaultPostHeaders(e.options);e.options.headers&&e.Utils.mixin(i,e.options.headers),await e.rest.Resource.delete(e,"/push/channelSubscriptions",i,{clientId:t,channel:this.channel.name},r,!0)}async listSubscriptions(e){return this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MICRO,"PushChannel.listSubscriptions()","channel = "+this.channel.name),this.client.push.admin.channelSubscriptions.list(z(q({},e),{channel:this.channel.name,concatFilters:!0}))}_getDeviceIdentityToken(){let t=this.client.device().deviceIdentityToken;if(t)return t;throw new this.client.ErrorInfo("Cannot subscribe from client without deviceIdentityToken",5e4,500)}_getPushAuthHeaders(){return{"X-Ably-DeviceToken":this._getDeviceIdentityToken()}}},F=N;function Q(n){let e=new Uint8Array(n.slice(0,n.byteLength));return btoa(String.fromCharCode.apply(null,Array.from(e)))}function le(n){let e="=".repeat((4-n.length%4)%4);return(n+e).replace(/-/g,"+").replace(/_/g,"/")}function ue(n){let e=window.atob(n),t=[];for(let r=0;r<e.length;r++)t.push(e[r].charCodeAt(0));return Uint8Array.from(t)}async function w(n){let e=n.GettingPushDeviceDetailsFailed,t=n.GotPushDeviceDetails,{ErrorInfo:r,Defaults:i}=n.client;if(await Notification.requestPermission()!=="granted"){n.handleEvent(new e(new r("User denied permission to send notifications",400,4e4)));return}let s=n.client.options.pushServiceWorkerUrl;if(!s){n.handleEvent(new e(new r("Missing ClientOptions.pushServiceWorkerUrl",400,4e4)));return}try{let a=await navigator.serviceWorker.register(s);n._pushManager=a.pushManager;let d=i.defaultGetHeaders(n.client.options,{format:"text"}),p=(await n.client.rest.Resource.get(n.client,"/push/publicVapidKey",d,{},null,!0)).body;a.active||await navigator.serviceWorker.ready;let l=await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:ue(le(p))}),M=l.endpoint,[K,G]=[l.getKey("p256dh"),l.getKey("auth")];if(!K||!G)throw new r("Public key not found",5e4,500);let V=n.client.device();V.push.recipient={transportType:"web",targetUrl:btoa(M),publicVapidKey:p,encryptionKey:{p256dh:Q(K),auth:Q(G)}},V.persist(),n.handleEvent(new t)}catch(a){n.handleEvent(new e(new r("Failed to register service worker",5e4,500,a)))}}function T(n){var e=new Error(n);return e.source="ulid",e}var L="0123456789ABCDEFGHJKMNPQRSTVWXYZ",I=L.length,$=Math.pow(2,48)-1,fe=10,de=16;function pe(n){var e=Math.floor(n()*I);return e===I&&(e=I-1),L.charAt(e)}function he(n,e){if(isNaN(n))throw new Error(n+" must be a number");if(n>$)throw T("cannot encode time greater than "+$);if(n<0)throw T("time must be positive");if(Number.isInteger(n)===!1)throw T("time must be an integer");for(var t=void 0,r="";e>0;e--)t=n%I,r=L.charAt(t)+r,n=(n-t)/I;return r}function ge(n,e){for(var t="";n>0;n--)t=pe(e)+t;return t}function me(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,e=arguments[1];e||(e=typeof window!="undefined"?window:null);var t=e&&(e.crypto||e.msCrypto);if(t)return function(){var i=new Uint8Array(1);return t.getRandomValues(i),i[0]/255};try{var r=X();return function(){return r.randomBytes(1).readUInt8()/255}}catch(i){}if(n){try{console.error("secure crypto unusable, falling back to insecure Math.random()!")}catch(i){}return function(){return Math.random()}}throw T("secure crypto unusable, insecure Math.random not allowed")}function ve(n){return n||(n=me()),function(t){return isNaN(t)&&(t=Date.now()),he(t,fe)+ge(de,n)}}var W=ve();var u={deviceId:"ably.push.deviceId",deviceSecret:"ably.push.deviceSecret",deviceIdentityToken:"ably.push.deviceIdentityToken",pushRecipient:"ably.push.pushRecipient",activationState:"ably.push.activationState"};function j(n){return class Z extends n{constructor(r){super();this.push={},this.rest=r}static load(r){let i=new Z(r);return i.loadPersisted(),i}async listSubscriptions(){if(!this.rest.Platform.Config.push)throw new this.rest.ErrorInfo("Push activation is not available on this platform",4e4,400);if(!this.id)throw new this.rest.ErrorInfo("Device not activated",4e4,400);if(!this.deviceIdentityToken)throw new this.rest.ErrorInfo("Cannot list device subscriptions without deviceIdentityToken",5e4,500);let i=this.rest,o=i.options.useBinaryProtocol?i.Utils.Format.msgpack:i.Utils.Format.json,s=i.http.supportsLinkHeaders?void 0:o,a=i.Defaults.defaultGetHeaders(i.options);return i.Utils.mixin(a,i.options.headers,{"X-Ably-DeviceToken":this.deviceIdentityToken}),new i.rest.PaginatedResource(i,"/push/channelSubscriptions",a,s,async function(d,p,l){return i.rest.PushChannelSubscription.fromResponseBody(d,i._MsgPack,l?void 0:o)}).get({deviceId:this.id})}loadPersisted(){var i;let r=this.rest.Platform;if(!r.Config.push)throw new this.rest.ErrorInfo("Push activation is not available on this platform",4e4,400);this.platform=r.Config.push.platform,this.clientId=(i=this.rest.auth.clientId)!=null?i:void 0,this.formFactor=r.Config.push.formFactor,this.id=r.Config.push.storage.get(u.deviceId),this.id?(this.deviceSecret=r.Config.push.storage.get(u.deviceSecret),this.deviceIdentityToken=JSON.parse(r.Config.push.storage.get(u.deviceIdentityToken)||"null"),this.push.recipient=JSON.parse(r.Config.push.storage.get(u.pushRecipient)||"null")):this.resetId()}persist(){let r=this.rest.Platform.Config;if(!r.push)throw new this.rest.ErrorInfo("Push activation is not available on this platform",4e4,400);this.id&&r.push.storage.set(u.deviceId,this.id),this.deviceSecret&&r.push.storage.set(u.deviceSecret,this.deviceSecret),this.deviceIdentityToken&&r.push.storage.set(u.deviceIdentityToken,JSON.stringify(this.deviceIdentityToken)),this.push.recipient&&r.push.storage.set(u.pushRecipient,JSON.stringify(this.push.recipient))}resetId(){this.id=W(),this.deviceSecret=W(),this.persist()}getAuthDetails(r,i,o){if(!this.deviceIdentityToken)throw new this.rest.ErrorInfo("Unable to update device registration; no deviceIdentityToken",5e4,500);return this.rest.http.supportsAuthHeaders?{headers:r.Utils.mixin({authorization:"Bearer "+r.Utils.toBase64(this.deviceIdentityToken)},i),params:o}:{headers:i,params:r.Utils.mixin({access_token:this.deviceIdentityToken},o)}}}}var k=class{constructor(e){this.GettingPushDeviceDetailsFailed=C;this.GotPushDeviceDetails=g;this.client=e,this._pushConfig=e.Platform.Config.push,this.current=new we[this.pushConfig.storage.get(u.activationState)||"NotActivated"](null),this.pendingEvents=[],this.handling=!1}get pushConfig(){if(!this._pushConfig)throw new this.client.ErrorInfo("This platform is not supported as a target of push notifications",4e4,400);return this._pushConfig}persist(){Ie(this.current)&&this.pushConfig.storage.set(u.activationState,this.current.name)}callUpdateRegistrationFailedCallback(e){this.updateFailedCallback?this.updateFailedCallback(e):this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_ERROR,"UpdateRegistrationFailed","Failed updating device push registration: "+this.client.Utils.inspectError(e))}callCustomRegisterer(e,t){var r;(r=this.registerCallback)==null||r.call(this,e,(i,o)=>{if(i){t?this.handleEvent(new m(i)):this.handleEvent(new E(i));return}o||this.handleEvent(new m(new this.client.ErrorInfo("registerCallback did not return deviceRegistration",4e4,400))),t?this.handleEvent(new y(o)):this.handleEvent(new S)})}callCustomDeregisterer(e){var t;(t=this.deregisterCallback)==null||t.call(this,e,r=>{if(r){this.handleEvent(new A(r));return}this.handleEvent(new D)})}async updateRegistration(){let e=this.client.device();if(this.registerCallback)this.callCustomRegisterer(e,!1);else{let t=this.client,r=t.options.useBinaryProtocol?this.client.Utils.Format.msgpack:this.client.Utils.Format.json,i=t.rest.DeviceDetails.fromLocalDevice(e),o=this.client.Defaults.defaultPostHeaders(this.client.options,{format:r}),s={};t.options.headers&&this.client.Utils.mixin(o,t.options.headers),t.options.pushFullWait&&this.client.Utils.mixin(s,{fullWait:"true"});let a=this.client.Utils.encodeBody(i,t._MsgPack,r),d=e.getAuthDetails(t,o,s);try{let p=await this.client.rest.Resource.patch(t,"/push/deviceRegistrations",a,d.headers,d.params,r,!0);this.handleEvent(new y(p.body))}catch(p){this.handleEvent(new m(p))}}}async deregister(){let e=this.client.device();if(this.deregisterCallback)this.callCustomDeregisterer(e);else{let t=this.client,r=t.options.useBinaryProtocol?this.client.Utils.Format.msgpack:this.client.Utils.Format.json,i=this.client.Defaults.defaultPostHeaders(t.options),o={deviceId:e.id};t.options.headers&&this.client.Utils.mixin(i,t.options.headers);let s=this.client.device().getAuthDetails(this.client,i,o);t.options.pushFullWait&&this.client.Utils.mixin(o,{fullWait:"true"});try{await this.client.rest.Resource.delete(t,"/push/deviceRegistrations",s.headers,s.params,r,!0),this.handleEvent(new D)}catch(a){this.handleEvent(new A(a))}}}callActivatedCallback(e){var t;(t=this.activatedCallback)==null||t.call(this,e),delete this.activatedCallback}callDeactivatedCallback(e){var t;(t=this.deactivatedCallback)==null||t.call(this,e),delete this.deactivatedCallback}handleEvent(e){if(this.handling){this.client.Platform.Config.nextTick(()=>{this.handleEvent(e)});return}this.handling=!0,this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","handling event "+e.name+" from "+this.current.name);let t=this.current.processEvent(this,e);if(!t){this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","enqueing event: "+e.name),this.pendingEvents.push(e),this.handling=!1;return}for(this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","transition: "+this.current.name+" -("+e.name+")-> "+t.name),this.current=t;this.pendingEvents.length>0;){let r=this.pendingEvents[0];if(this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","attempting to consume pending event: "+r.name),t=this.current.processEvent(this,r),!t)break;this.pendingEvents.splice(0,1),this.client.Logger.logAction(this.client.logger,this.client.Logger.LOG_MAJOR,"Push.ActivationStateMachine.handleEvent()","transition: "+this.current.name+" -("+r.name+")-> "+t.name),this.current=t}this.persist(),this.handling=!1}},c=class{constructor(e,t){this.name="CalledActivate";t&&(e.registerCallback=t),e.persist()}},f=class{constructor(e,t){this.name="CalledDeactivate";e.deregisterCallback=t,e.persist()}},g=class{constructor(){this.name="GotPushDeviceDetails"}},C=class{constructor(e){this.name="GettingPushDeviceDetailsFailed";this.reason=e}},y=class{constructor(e){this.name="GotDeviceRegistration";this.tokenDetails=e.deviceIdentityToken}},m=class{constructor(e){this.name="GettingDeviceRegistrationFailed";this.reason=e}},S=class{constructor(){this.name="RegistrationSynced"}},E=class{constructor(e){this.name="SyncRegistrationFailed";this.reason=e}},D=class{constructor(){this.name="Deregistered"}},A=class{constructor(e){this.name="DeregistrationFailed";this.reason=e}},h=class{constructor(e){this.name=e}},v=class n extends h{constructor(){super("NotActivated")}processEvent(e,t){var r,i;if(t instanceof f)return e.callDeactivatedCallback(null),new n;if(t instanceof c){let o=e.client.device();return o.deviceIdentityToken!=null?o.clientId&&o.clientId!==e.client.auth.clientId?(e.handleEvent(new E(new e.client.ErrorInfo("clientId not compatible with local device clientId",61002,400))),null):(e.pendingEvents.push(t),new b):(o.push.recipient?e.pendingEvents.push(new g):e.pushConfig.getPushDeviceDetails?(i=(r=e.pushConfig).getPushDeviceDetails)==null||i.call(r,e):e.pushConfig.platform==="browser"?w(e):e.handleEvent(new C(new e.client.ErrorInfo("No available implementation to get push device details",5e4,500))),new U)}else if(t instanceof g)return new n;return null}},U=class n extends h{constructor(){super("WaitingForPushDeviceDetails")}processEvent(e,t){if(t instanceof c)return new n;if(t instanceof f)return e.callDeactivatedCallback(null),new v;if(t instanceof g){let r=e.client,i=r.device();if(e.registerCallback)e.callCustomRegisterer(i,!0);else{let o=r.options.useBinaryProtocol?e.client.Utils.Format.msgpack:e.client.Utils.Format.json,s=r.rest.DeviceDetails.fromLocalDevice(i),a=e.client.Defaults.defaultPostHeaders(r.options,{format:o}),d={};r.options.headers&&e.client.Utils.mixin(a,r.options.headers),r.options.pushFullWait&&e.client.Utils.mixin(d,{fullWait:"true"});let p=e.client.Utils.encodeBody(s,r._MsgPack,o);e.client.rest.Resource.post(r,"/push/deviceRegistrations",p,a,d,null,!0).then(l=>{let M=l.unpacked?l.body:r.rest.DeviceDetails.fromResponseBody(l.body,r._MsgPack,o);e.handleEvent(new y(M))}).catch(l=>{e.handleEvent(new m(l))})}return new B}else if(t instanceof C)return e.callActivatedCallback(t.reason),new v;return null}},B=class n extends h{constructor(){super("WaitingForDeviceRegistration")}processEvent(e,t){if(t instanceof c)return new n;if(t instanceof y){let r=e.client.device();return r.deviceIdentityToken=t.tokenDetails.token,r.persist(),e.callActivatedCallback(null),new b}else if(t instanceof m)return e.callActivatedCallback(t.reason),new v;return null}},b=class n extends h{constructor(){super("WaitingForNewPushDeviceDetails")}processEvent(e,t){return t instanceof c?(e.callActivatedCallback(null),new n):t instanceof f?(e.deregister(),new x(this)):t instanceof g?(e.updateRegistration(),new P):null}},P=class n extends h{constructor(t=!1){super("WaitingForRegistrationSync");this.triggeredByCalledActivate=t}processEvent(t,r){return r instanceof c&&!this.triggeredByCalledActivate?(t.callActivatedCallback(null),new n(!0)):r instanceof S?new b:r instanceof E?(t.callUpdateRegistrationFailedCallback(r.reason),new O):null}},O=class extends h{constructor(){super("AfterRegistrationSyncFailed")}processEvent(e,t){return t instanceof c||t instanceof g?(e.updateRegistration(),new P(t instanceof c)):t instanceof f?(e.deregister(),new x(this)):null}},x=class n extends h{constructor(t){super("WaitingForDeregistration");this.previousState=t}processEvent(t,r){if(r instanceof f)return new n(this.previousState);if(r instanceof D){let i=t.client.device();return delete i.deviceIdentityToken,delete i.push.recipient,i.resetId(),i.persist(),t.callDeactivatedCallback(null),new v}else if(r instanceof A)return t.callDeactivatedCallback(r.reason),this.previousState;return null}},we={NotActivated:v,WaitingForPushDeviceDetails:U,WaitingForDeviceRegistration:B,WaitingForNewPushDeviceDetails:b,WaitingForRegistrationSync:P,AfterRegistrationSyncFailed:O,WaitingForDeregistration:x};function Ie(n){return n.name=="NotActivated"||n.name=="WaitingForNewPushDeviceDetails"}var ke={ActivationStateMachine:k,localDeviceFactory:j,CalledActivate:c,CalledDeactivate:f,PushChannel:F,getW3CPushDeviceDetails:w};
if (typeof module.exports == "object" && typeof exports == "object") {
  var __cp = (to, from, except, desc) => {
    if ((from && typeof from === "object") || typeof from === "function") {
      for (let key of Object.getOwnPropertyNames(from)) {
        if (!Object.prototype.hasOwnProperty.call(to, key) && key !== except)
        Object.defineProperty(to, key, {
          get: () => from[key],
          enumerable: !(desc = Object.getOwnPropertyDescriptor(from, key)) || desc.enumerable,
        });
      }
    }
    return to;
  };
  module.exports = __cp(module.exports, exports);
}
return module.exports;
}))
//# sourceMappingURL=push.umd.min.js.map
